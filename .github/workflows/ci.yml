name: CI

on:
  pull_request:

jobs:
  test:
    name: test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Guard against hidden or bidi Unicode in workflows
        shell: bash
        run: |
          node <<'NODE'
          const fs = require("node:fs");
          const path = require("node:path");

          const workflowDir = path.join(process.cwd(), ".github", "workflows");
          const candidates = fs.existsSync(workflowDir)
            ? fs
                .readdirSync(workflowDir)
                .filter((name) => name.endsWith(".yml") || name.endsWith(".yaml"))
                .map((name) => path.join(workflowDir, name))
            : [];

          const forbiddenRanges = [
            [0x202a, 0x202e], // bidi embedding/override
            [0x2066, 0x2069], // bidi isolates
            [0x200e, 0x200f], // LRM/RLM
            [0x061c, 0x061c], // Arabic letter mark
            [0x200b, 0x200d], // zero-width chars
            [0xfeff, 0xfeff], // BOM/ZWNBSP
          ];

          const findings = [];
          for (const file of candidates) {
            const text = fs.readFileSync(file, "utf8");
            let line = 1;
            let col = 1;
            for (const ch of text) {
              const cp = ch.codePointAt(0);
              const hit = forbiddenRanges.some(([start, end]) => cp >= start && cp <= end);
              if (hit) {
                findings.push({
                  file: path.relative(process.cwd(), file),
                  line,
                  col,
                  cp: `U+${cp.toString(16).toUpperCase().padStart(4, "0")}`,
                });
              }
              if (ch === "\n") {
                line += 1;
                col = 1;
              } else {
                col += 1;
              }
            }
          }

          if (findings.length > 0) {
            console.error("Forbidden hidden/bidi Unicode detected in workflow files:");
            for (const f of findings) {
              console.error(`- ${f.file}:${f.line}:${f.col} ${f.cp}`);
            }
            process.exit(1);
          }

          console.log("Workflow Unicode guard passed.");
          NODE

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run format check
        run: pnpm run format:check

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Run all tests
        run: pnpm run test:ci
        env:
          CI: true
