# Claw-Empire v1.2.3 Release Notes

- Release date: 2026-02-27
- Scope: Local `main` working-tree update snapshot (unreleased) focused on direct messenger integration hardening, project-binding flow correctness, channel-isolated report delivery, and direct-chat reliability.

## Local Git Update Snapshot

- Branch: `main`
- Working tree: dirty (uncommitted)
- Application code/test diff summary (excluding docs):
  - `8 files changed`
  - `1234 insertions(+), 407 deletions(-)`
- Primary touched files:
  - `server/modules/routes/collab/direct-chat.ts`
  - `server/modules/routes/collab.ts`
  - `server/gateway/client.ts`
  - `server/messenger/session-agent-routing.ts`
  - `server/modules/routes/collab/task-delegation.ts`
  - tests: `server/gateway/client.test.ts`, `server/modules/routes/collab/direct-chat.normalize.test.ts`, `server/messenger/session-agent-routing.test.ts`

## Highlights

### Built-in Messenger Routing and Delivery Isolation

- **Task-scoped channel route pinning**:
  - Added `[messenger-route] <channel>:<target>` audit line + runtime cache in `collab.ts`.
  - Task completion reports now relay only to the originating task channel/target instead of broadcasting across all mapped sessions.
- **Route cache guardrails**:
  - Added TTL pruning (`7 days`) and max-size cap (`1024`) for in-memory task messenger route cache.
- **Agent session route resolution expansion**:
  - Added `resolveAgentSessionRoutesFromSettings/Db` helpers for agent-bound session lookup.

### Direct Chat -> Messenger UX Improvements

- **Typing indicator support**:
  - Telegram: `sendChatAction(action=typing)`.
  - Discord: `/typing` endpoint.
  - Slack: explicit no-op (no native bot typing endpoint).
- **Typing heartbeat during generation**:
  - Direct-chat generation now sends periodic typing beats and stops on completion/failure.
- **Duplicate reply mitigation**:
  - Added stronger normalization/deduplication path to collapse repeated sentence blocks in agent replies before messenger relay.

### Project Binding Flow Fixes (No Auto-Creation Without Confirmation)

- **State-machine prompt flow before task escalation**:
  - `ask_kind -> ask_existing | ask_new_name -> ask_new_path`
  - Prevents immediate project auto-creation when context is missing.
- **Multilingual project-kind inference fallback**:
  - Numeric/text choice parsing with model-based fallback for ambiguous user replies.
- **Contextual task intent improvements**:
  - Expanded direct-chat task-intent detection keywords and follow-up kickoff/affirmative escalation handling.
- **Removed duplicate “project ready” spam path**:
  - Reduced repeated guidance loops while preserving project-binding gating.

### Security and Type Safety

- **Project path creation policy (path traversal hardening)**:
  - New project directory creation in direct chat is now restricted to allowed roots.
  - Configurable via `PROJECT_PATH_ALLOWED_ROOTS`.
  - Default roots: `~/Projects`, `~/projects`, `process.cwd()`.
- **Task delegation type strictness**:
  - Replaced `db: any` with `RuntimeContext["db"]` in task-delegation deps.

## API/Behavior Notes

- Direct messenger endpoints continue to be served from Claw-Empire runtime (`/api/messenger/*`).
- Messenger session payload supports `agentId` binding in persisted settings.
- Wake notifications skip agent-bound sessions (`agentId` present) to avoid cross-channel spam.

## Verification Summary

- Type check:
  - `pnpm -s tsc -b --pretty false` (pass)
- Targeted tests:
  - `pnpm -s vitest --config server/vitest.config.ts run server/modules/routes/collab/direct-chat.normalize.test.ts server/gateway/client.test.ts server/messenger/session-agent-routing.test.ts` (pass)

## Notable Risk/Compatibility Notes

- Slack does not show typing indicators (provider API limitation).
- `PROJECT_PATH_ALLOWED_ROOTS` should be explicitly configured in hardened environments to avoid accidental broad roots.
