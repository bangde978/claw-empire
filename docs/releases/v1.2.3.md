# Claw-Empire v1.2.3 Release Notes

- Release date: 2026-02-27
- Scope: Direct messenger integration and decision-routing stabilization update, covering multi-channel session UX, channel-isolated relay behavior, in-messenger decision replies, and project-binding safety hardening.

## Highlights

### 1. Unified Built-in Messenger Channels

- Added a shared messenger channel catalog used across runtime, routing, gateway, and UI layers.
- Built-in channels are now normalized to:
  - `telegram`
  - `whatsapp`
  - `discord`
  - `googlechat`
  - `slack`
  - `signal`
  - `imessage`
- Runtime channel configuration is persisted in SQLite (`settings.messengerChannels`) and consumed consistently by server gateway and UI.

### 2. Settings Tab UX Redesign (Chat Sessions)

- Replaced per-channel fragmented editing flow with a unified "Add Chat" / "Edit Chat" modal UX.
- Session create/edit/delete now supports channel, token, target, name, enabled flag, and mapped agent in one place.
- Confirm in modal immediately persists settings (no extra global save step for chat-session changes).
- Chat list now shows mapped agent avatar + name next to each session for faster operator context.
- Added explicit helper copy at the top of Channel Messaging tab to guide users on registering messenger/token/target ID/conversation agent.

### 3. Channel-Isolated Task Relay

- Task relay remains pinned to the origin route via `[messenger-route] <channel>:<target>`.
- Relay policy was expanded from completion-only reports to task broadcast messages:
  - `report`
  - `chat`
  - `status_update`
- Result: meeting kickoff/progress/completion messages are delivered only to the originating channel route, preventing cross-channel spread.
- Added in-memory route cache guardrails (TTL + max size) for route lookup stability.

### 4. Decision Inbox Messenger Bridge

- Decision requests are now delivered to the same messenger route tied to task/project context.
- Added persistent dedupe reservation/sent markers to prevent duplicate decision notices across retries/restarts.
- Users can answer decisions directly in messenger with numeric replies:
  - single: `1`
  - multi-pick (review round): `1,3` or `1 3`
- Decision reply parsing is multilingual and route-aware, then applied via the existing decision handlers.
- Reply ACK/ERR is sent back to the same messenger channel/target.
- Numeric multi-choice parsing was hardened so plain replies like `1,2,3,4` are treated as decision replies when a pending decision exists.
- If no pending decision exists, plain numeric chat remains regular agent conversation flow (no forced decision interception).

### 5. Decision Message Readability Improvements

- Decision request messages were reformatted for messenger readability:
  - compact summary text
  - concise option previews
  - plain numeric reply guidance
- Removed default heavy technical token noise (advanced token reply line) from normal operator view.
- Kept token-based explicit reply parsing supported internally for compatibility.

### 6. Direct Chat Workflow and Safety Hardening

- Direct-chat project flow enforces existing/new project selection before escalation.
- Improved multilingual intent/project-kind fallback to reduce looped prompts.
- New project path creation is restricted by allowed roots (`PROJECT_PATH_ALLOWED_ROOTS`) to harden path traversal risk.
- Added duplicate sentence normalization mitigation for cleaner outbound replies.
- Task-delegation/runtime typing tightened (`db: any` -> strict runtime DB types in deps).

### 7. Messenger Completion Report Readability Patch

- Long completion reports (table-heavy/large payload) are now transformed into compact messenger summaries:
  - title + top key results
  - progress summary line when available
  - pointer to full details in Claw-Empire chat
- The first report line is now generated with agent identity (avatar + name) instead of fixed generic completion wording.
- This keeps in-messenger readability high while preserving full report detail in the in-app chat thread.

## API and Behavior Notes

- Direct messenger endpoints remain under `/api/messenger/*`.
- `/api/inbox` now includes decision-reply bridge handling before regular agent-chat reply scheduling when applicable.
- Messenger session payloads support per-session `agentId` mapping.
- `.env` messenger token/channel variables are no longer the primary config path; UI/DB configuration is the canonical runtime source.

## Verification Summary

- Type check:
  - `pnpm -s tsc -b --pretty false` (pass)
- Targeted tests:
  - `pnpm -s vitest --config server/vitest.config.ts run server/gateway/client.test.ts server/messenger/session-agent-routing.test.ts server/modules/routes/collab/direct-chat.normalize.test.ts` (pass)

## Compatibility Notes

- Slack typing indicator remains no-op due provider/API constraints.
- For stricter environments, set `PROJECT_PATH_ALLOWED_ROOTS` explicitly instead of relying on defaults.
