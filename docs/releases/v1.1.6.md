# Claw-Empire v1.1.6 Release Notes

- Release date: 2026-02-22
- Scope: GitHub project integration — dev-branch merge + automatic PR creation workflow, GitHub Import enhancements, base-branch support for worktrees, and frontend bugfixes.

## Highlights

- **GitHub Project Dev-Branch Merge + PR Flow**
  - For GitHub-imported projects (`github_repo` set), completed tasks now merge into `dev` branch instead of `main`.
  - After merging to `dev`, the branch is pushed to origin and a GitHub Pull Request (dev → main) is automatically created.
  - If an open dev → main PR already exists, the push updates it automatically without creating a duplicate.
  - Local-only projects (no `github_repo`) retain the existing direct-to-main merge behavior.

- **`github_repo` Column & API Support**
  - Added `github_repo TEXT` column to the `projects` table (nullable, format: `owner/repo`).
  - `POST /api/projects` and `PATCH /api/projects/:id` now accept and persist `github_repo`.
  - Frontend `createProject()` and `updateProject()` API functions support `github_repo` parameter.
  - `Project` TypeScript type includes `github_repo?: string | null`.

- **GitHub Import Panel Enhancements**
  - GitHub Import now automatically sets `github_repo` to the repository's `full_name` when creating a project.
  - Fixed `process is not defined` error — removed browser-incompatible `process.env` references; `~` path resolution now handled server-side.
  - Fixed `[object Object]` project ID error — `createProject()` return value is now correctly unwrapped to `project.id`.

- **Server-Side `~` Path Resolution for Clone**
  - `POST /api/github/clone` now resolves `~` and `~/...` paths server-side, matching `normalizeProjectPathInput` behavior.

- **Base-Branch Support for Worktrees**
  - `createWorktree()` now accepts an optional `baseBranch` parameter.
  - Task execution in orchestration uses `base_branch` from the task record when creating worktrees.
  - `POST /api/tasks` now accepts and persists `base_branch` field.

- **Workflow: `mergeToDevAndCreatePR()` Function**
  - New function in `workflow/core.ts`: ensures `dev` branch exists, merges task branch with `--no-ff`, pushes to origin, and creates/updates GitHub PR asynchronously.
  - Uses `getGitHubToken()` to retrieve active GitHub OAuth token from DB for push authentication and API calls.
  - On merge conflict, aborts merge, returns to `main`, and reports conflicting files.
  - Wired through `RuntimeContext` → `WorkflowCoreExports` → `workflow.ts` → `orchestration.ts`.

- **Orchestration: GitHub-Aware Finalization**
  - `finalizeApprovedReview()` now checks `project.github_repo` before merging.
  - GitHub projects → `mergeToDevAndCreatePR()` with multilingual "(dev merge + PR)" note.
  - Local projects → existing `mergeWorktree()` with "(merged)" note (unchanged).

## Changed Files

### Frontend
- `src/api.ts`
- `src/components/GitHubImportPanel.tsx`
- `src/types/index.ts`

### Backend
- `server/server-main.ts`
- `server/modules/routes/core.ts`
- `server/modules/routes/ops.ts`
- `server/modules/workflow/core.ts`
- `server/modules/workflow/orchestration.ts`
- `server/modules/workflow.ts`
- `server/types/runtime-context.ts`

### Docs
- `README.md`
- `README_ko.md`
- `README_jp.md`
- `README_zh.md`
- `docs/releases/README.md`
- `docs/releases/v1.1.6.md`

## Verification

- `pnpm run build`
  - `tsc --noEmit` passed
  - `vite build` passed

## Notes

- GitHub PR creation is fire-and-forget (async) — the synchronous merge+push completes first, then PR is created/updated in the background with task log entries.
- The `dev` branch is automatically created from `main` if it doesn't exist when the first GitHub-project task completes.
- `cleanupWorktree` only deletes the task branch (`climpire/xxx`); `dev` branch is always preserved.
