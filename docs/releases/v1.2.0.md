# Claw-Empire v1.2.0 Release Notes

- Release date: 2026-02-25
- Scope: Agent management (hire/edit/delete), department CRUD, department management tab, new pixel character sprite (#13), project-level manual agent assignment, meeting participant filtering for manual projects, mobile-responsive Project Manager, custom skill upload system, bug fixes, plus post-release hardening and engineering-quality updates merged into v1.2.0.

## Highlights

### Agent Management (CRUD)
- **Hire New Agent** - Full agent creation UI in Agent Manager with name (multilingual: en/ko/ja/zh), department, role (team_leader/senior/junior/intern), CLI provider, sprite number, avatar emoji, and personality fields.
- **Edit Agent** - Inline edit for all agent fields including provider/model reassignment.
- **Delete Agent** - Safe deletion with working-status guard; cascading NULL-ification on tasks, subtasks, meeting minutes, report archives, and review decision states.
- Backend: `POST /api/agents`, `PATCH /api/agents/:id`, `DELETE /api/agents/:id` endpoints with WebSocket broadcast (`agent_created`, `agent_deleted`).

### Department CRUD
- **Create Department** - Full department creation with ID validation (`a-z0-9` pattern), multilingual names, icon, color picker, description, and prompt.
- **Edit Department** - Inline editing of all department properties.
- **Delete Department** - Removal with associated agent/task guards.
- Backend: `POST /api/departments`, `PATCH /api/departments/:id`, `DELETE /api/departments/:id` endpoints with `departments_changed` broadcast.

### Department Management Tab
- Added **subtab toggle** (`Agents | Departments`) inside Agent Manager.
- Department list view with sort order, icon, name, color, agent count, description, and ID.
- **Sort order editing** via arrow buttons and drag-and-drop, with batch save.
- Backend: `PATCH /api/departments/reorder` endpoint using temporary high-value `sort_order` to avoid UNIQUE constraint conflicts during reorder.
- Routing guard added so `/api/departments/reorder` is not captured by `/api/departments/:id`.

### New Character Sprite (Sprite #13)
- Added a new pixel character with full directional sprite set (D-1/D-2/D-3, L-1, R-1).
- Added a sprite generation pipeline script.
- AgentAvatar and OfficeView updated for sprite #13 support.

### Project Manual Agent Assignment
- Projects now support `assignment_mode`: `auto` (default) or `manual`.
- In manual mode, specific agents can be assigned via multi-select checkbox UI with sprite avatar icons and department/role labels.
- New DB schema: `assignment_mode` column on `projects` table + `project_agents` junction table.
- Backend CRUD: `POST /api/projects` and `PATCH /api/projects/:id` accept `assignment_mode` and `agent_ids`.
- `GET /api/projects` and `GET /api/projects/:id` return `assigned_agent_ids` per project.

### Meeting Participant Filtering (Manual Mode)
- When a project uses `assignment_mode: manual`, kickoff and review meetings only include:
  - **Planning team leader** (always included)
  - **Team leaders from departments of the assigned agents**
- `fallbackAll` expansion (invite all active team leaders) is skipped for manual-mode projects.
- Applies to both kickoff (`startPlannedApprovalMeeting`) and review (`startReviewConsensusMeeting`) meetings.

### Task Delegation with Manual Mode
- `findBestSubordinate` in `collab.ts` accepts optional `candidateAgentIds`.
- Manual mode queries `project_agents` and restricts candidates to the assigned agent pool.
- Candidate filtering is additionally constrained to the active team leader's department.
- If no assigned candidate exists for that department in manual mode, fallback to full-department auto selection is blocked.
- Auto mode projects retain existing delegation logic unchanged.

### ChatPanel Manual Mode Indicator
- Project confirm step displays assigned agent count for manual-mode projects (for example: "Manual mode - 2 assigned agents will work on this").

### Mobile-Responsive Project Manager
- **List-detail toggle pattern** for mobile viewports (below `md` / 768px):
  - Project list takes full width when no project is selected.
  - Selecting a project or creating new hides the list and shows detail view.
  - Mobile-only back button returns to project list.
- Desktop layout remains side-by-side.

### Bug Fixes
- Fixed project save `500` caused by unresolved `runInTransaction` binding in `core.ts`.
- Improved light-mode error readability in `ProjectManagerModal` (`text-rose-800`/`text-cyan-800` variants).
- Fixed `/api/departments/reorder` save failure caused by route collision with `/api/departments/:id`.
- Added internal scroll behavior for Agent Manager emoji picker (`max-h` + `overflow-y-auto`).
- Added internal scroll behavior for Agent Manager hire/edit modal (`max-h` + `overflow-y-auto`).

### Custom Skill Upload System
- **Custom skill CRUD** — Users can upload `.md` skill files directly through the Skills Library UI, name the skill, select CLI representatives to train, and delete existing custom skills.
- **Classroom training animation** — Uploading a custom skill triggers a full-screen chalkboard classroom animation showing the claw-empire mascot as teacher and CLI representative agents as students.
- **Backend endpoints**: `POST /api/skills/custom` (upload), `GET /api/skills/custom` (list), `DELETE /api/skills/custom/:skillName` (delete) with file-based storage under `custom-skills/` directory and `skill_learning_history` DB records.
- **Frontend API client**: `uploadCustomSkill()`, `getCustomSkills()`, `deleteCustomSkill()` added to `src/api.ts`.
- **Light mode support**: Full light-mode CSS overrides for custom skill buttons, modal, list cards, and classroom animation overlay.

### Post-release Hardening (still v1.2.0)
- **Manual assignment pre-save safeguard modal**: Project Manager now warns when manual assignment is saved with no selected agents or team-leader-only selections, showing selection summary and requiring explicit confirmation.
- **Manual selection visibility**: Manual assignment UI now shows live counts (`total`, `leaders`, `subordinates`) to prevent accidental subordinate omission.
- **Project API `agent_ids` validation**: `POST /api/projects` and `PATCH /api/projects/:id` now validate `agent_ids` type and existence; invalid IDs are rejected with explicit error payloads.
- **Delegation fallback auditability**: In manual mode, when no eligible subordinate exists in assigned candidates, system logs explicit fallback context and sends a CEO-facing safeguard notice before team-leader direct execution.
- **Sprite registration conflict guard**: `POST /api/sprites/register` now returns `409 sprite_number_exists` if target sprite files already exist, preventing accidental overwrite.
- **Portable sprite generation script**: Sprite generation now resolves output path relative to repository and auto-creates `public/sprites`, removing machine-specific absolute path dependency.
- **Department sort_order UNIQUE index safe migration**: `server-main.ts` now drops and re-creates the `idx_departments_sort_order` UNIQUE index around sort_order seed updates to avoid constraint violations during migration.

### Engineering Quality Pack (still v1.2.0)
- **CI E2E coverage expansion**: Added a new broad E2E suite (`tests/e2e/ci-coverage-gap.spec.ts`) covering task lifecycle, Department/Agent/Project CRUD smoke flow, chat/directive flow, settings/stats/decision-inbox, report/terminal, and WebSocket event reception.
- **CI E2E stabilization**: Hardened flaky points with transient 502/503 retry handling in API polling paths and deterministic Playwright execution (`workers: 1`, `reuseExistingServer: false`) for stable CI reproducibility.
- **Server type-debt cleanup (`@ts-nocheck` removal)**: Removed `@ts-nocheck` usage from server runtime modules by tightening runtime/shared types and preserving behavior with modular helper extraction.
- **Repository-wide formatting standardization**: Introduced Prettier baseline (`.prettierrc.json`, `.prettierignore`), added `format`/`format:check` scripts, and enforced formatting in CI (`pnpm run format:check`).
- **Unit test surface expansion**:
  - Frontend: added tests for `src/api.ts`, `useWebSocket`, `usePolling`, and `i18n` helpers.
  - Backend: added tests for `server/security/auth.ts`, `server/ws/hub.ts`, `server/db/runtime.ts`, and `server/gateway/client.ts`.

## Changed Files

### Frontend
- `src/types/index.ts` - Added `AssignmentMode` and extended `Project`.
- `src/api.ts` - Added `reorderDepartments()`, extended project CRUD fields, custom skill API functions (`uploadCustomSkill`, `getCustomSkills`, `deleteCustomSkill`).
- `src/api.test.ts` - Request format, retry/auth, idempotency-post, and error-shape coverage.
- `src/App.tsx` - Agent/department live-sync updates.
- `src/components/AgentManager.tsx` - Agent CRUD UI, department tab, reorder UX.
- `src/components/AgentAvatar.tsx` - Sprite #13 support.
- `src/components/AgentDetail.tsx`
- `src/components/AgentSelect.tsx`
- `src/components/AgentStatusPanel.tsx`
- `src/components/Dashboard.tsx`
- `src/components/OfficeView.tsx`
- `src/components/ProjectManagerModal.tsx` - Manual assignment safeguard modal, selection stats badges, and warning reset behavior.
- `src/components/SkillsLibrary.tsx` - Custom skill upload modal, custom skill list with delete, classroom training animation with portal, light-mode CSS class hooks.
- `src/components/TaskBoard.tsx`
- `src/components/ChatPanel.tsx`
- `src/hooks/useWebSocket.test.tsx` - Connection/reconnection/event-dispatch behavior.
- `src/hooks/usePolling.test.tsx` - Interval polling + visibility pause/resume behavior.
- `src/i18n.test.ts` - Language normalization/detection/fallback behavior.
- `src/index.css` - Custom skill button/modal/list/classroom animation styles (dark + light mode), keyframe animations for classroom scene.

### Backend
- `server/server-main.ts` - DB migration (`assignment_mode`, `project_agents`), department `sort_order` UNIQUE index safe migration (drop → seed → recreate).
- `server/modules/routes/core.ts` - Agent/department/project APIs, reorder routing guard, transaction binding fix, project `agent_ids` validation, sprite register conflict guard.
- `server/modules/routes/collab.ts` - Manual-mode candidate filtering hardening, leader-fallback safeguard logging/CEO notice.
- `server/modules/routes/ops.ts` - Custom skill CRUD endpoints (`POST/GET /api/skills/custom`, `DELETE /api/skills/custom/:skillName`) with file storage and DB history integration.
- `server/modules/workflow/orchestration/meetings.ts` - Manual-mode meeting participant filtering.
- `server/security/auth.ts`
- `server/security/auth.test.ts` - Cookie/bearer/origin/session guard tests.
- `server/ws/hub.test.ts` - Batched broadcast/queue-cap tests.
- `server/db/runtime.test.ts` - Env parsing/guardrail constant tests.
- `server/gateway/client.test.ts` - Gateway invoke success/failure tests.

### Assets
- `public/sprites/13-D-1.png`, `13-D-2.png`, `13-D-3.png`, `13-L-1.png`, `13-R-1.png`
- `public/sprites/14-D-1.png`, `14-D-2.png`, `14-D-3.png`, `14-L-1.png`, `14-R-1.png`
- Sprite generation script - Portable output path + auto directory creation.

### Docs
- `README.md`
- `README_ko.md`
- `README_jp.md`
- `README_zh.md`
- `docs/releases/README.md`
- `docs/releases/v1.2.0.md`

### CI / Tooling
- `tests/e2e/ci-coverage-gap.spec.ts` - New CI E2E gap-coverage scenarios.
- `tests/e2e/ci-manual-assignment.spec.ts` - Manual-assignment E2E stabilization (transient API retry).
- `playwright.config.ts` - CI-stable execution defaults (`workers: 1`, `reuseExistingServer: false`).
- `.prettierrc.json`, `.prettierignore` - Formatting baseline for repository standardization.
- `.github/workflows/ci.yml` - Added `pnpm run format:check` in CI.

## Verification

- `npx tsc --noEmit` - passed
- `npx vite build` - passed
- `pnpm run build` - passed
- `pnpm run test` - passed
- `pnpm run format:check` - passed
- `pnpm run test:web` - passed
- `pnpm run test:api` - passed
- `pnpm run test:e2e` - passed
- `pnpm run test:ci` - passed
