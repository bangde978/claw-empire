# Claw-Empire v1.2.2 Release Notes

- Release date: 2026-02-26
- Scope: Post-v1.2.1 functional release introducing the interrupt-inject workflow (paused-session prompt injection), plus task-control security hardening and per-agent CLI model override controls from Office Agent Detail.

## Highlights

### Interrupt-Inject Feature Rollout

- **New paused-session prompt injection endpoint**: Added `POST /api/tasks/:id/inject` to queue sanitized interrupt prompts for paused runs.
- **Session-proofed control path**:
  - Added task interrupt control token validation (`x-task-interrupt-token` or request body `interrupt_token`).
  - Added CSRF validation gate for cookie-authenticated task mutations (`stop`, `resume`, `inject`).
- **Queued injection persistence**:
  - Added `task_interrupt_injections` flow helpers (sanitize/hash/queue/consume) and prompt hash audit logs.
  - Terminal API now returns interrupt proof payload (`session_id`, `control_token`, `requires_csrf`) to support safe UI resume/inject flows.
- **TerminalPanel operational UX**:
  - Added Interrupt/Inject panel with pause-only, inject+resume, and resume-only actions.
  - Added short retry strategy for pending proof retrieval and clear multilingual operator feedback messages.
- **Verification coverage**:
  - Added route and workflow unit tests for interrupt token handling, CSRF constraints, and injection queue behavior.
  - Added HTTP smoke helper script: `scripts/qa/interrupt-inject-http-smoke.mjs`.

### Agent-Level CLI Model Overrides (Office)

- **Schema/API extension for agents**:
  - Added `agents.cli_model` and `agents.cli_reasoning_level`.
  - Extended `/api/agents/:id` patch validation and provider-aware cleanup rules.
- **Agent Detail editor upgrade**:
  - CLI providers (`claude`, `codex`, `gemini`, `opencode`) can now set per-agent main model overrides directly in Office.
  - Codex adds per-agent reasoning effort override (`low`/`medium`/`high`/`xhigh`) with default fallback support.
  - When set to default, runtime uses global Settings model config as before.
  - Sub-agent model selection remains driven by global Settings (`providerModelConfig.subModel`), not per-agent override.
- **Runtime override propagation**:
  - Applied to all major execution entry points:
    - task run
    - resume/start orchestration path
    - one-shot runner
    - direct spawn
    - delegated subtask batch
    - cross-department cooperation

### Planning-Lead No-Tools Fast Path

- **Team-lead meetings keep no-tools policy**:
  - Planned approval and review consensus one-shot rounds execute with `noTools: true` for faster turn completion.
- **Decision inbox planning consolidation now no-tools**:
  - Project-level review planning consolidation (`project_review_ready`) runs with `noTools: true`.
  - Review-round planning consolidation (`review_round_pick`) runs with `noTools: true`.
- **Final report consolidation now no-tools**:
  - Planning leader's final consolidated archive generation runs with `noTools: true` to reduce tool-call overhead.

### UI/Theme Readability Polish

- **Interrupt action contrast fix**:
  - Added theme-level danger tokens and updated interrupt button styling for better readability in light mode.

## API/Docs Updates

- Updated API docs (`docs/api.md`) to include:
  - CSRF bootstrap/header expectations
  - Interrupt session proof requirements
  - New `POST /api/tasks/:id/inject` endpoint

## Notable Files

- Interrupt control and injection:
  - `server/modules/routes/core/tasks/execution-control.ts`
  - `server/modules/workflow/core/interrupt-injection-tools.ts`
  - `src/components/TerminalPanel.tsx`
  - `src/api/organization-projects.ts`
- Agent-level CLI model overrides:
  - `src/components/AgentDetail.tsx`
  - `server/modules/routes/core/agents/crud.ts`
  - `server/modules/routes/core/tasks/execution-run.ts`
  - `server/modules/workflow/orchestration/execution-start-task.ts`
  - `server/modules/workflow/core/one-shot-runner.ts`
- Planning-lead no-tools policy coverage:
  - `server/modules/workflow/orchestration/planned-approval.ts`
  - `server/modules/workflow/orchestration/meetings/review-consensus.ts`
  - `server/modules/routes/ops/messages/decision-inbox/project-review-planning.ts`
  - `server/modules/routes/ops/messages/decision-inbox/review-round-planning.ts`
  - `server/modules/workflow/orchestration/planning-archive-tools.ts`
- Schema/type updates:
  - `server/modules/bootstrap/schema/base-schema.ts`
  - `server/modules/bootstrap/schema/oauth-runtime.ts`
  - `src/types/index.ts`
  - `server/modules/routes/shared/types.ts`

## Verification Summary

- `pnpm lint` (passes; existing repository warnings unchanged)
- `pnpm build` (passes)
- `pnpm test:api` (passes)
